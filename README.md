# zMAP

The design of zMAP aims to simultaneously compare protein profiles of multiple samples and integrate samples from different MS runs for identifying hypervariable 
proteins across samples. zMAP models the mean-variance dependence associated with ILMS intensities and accordingly applies a variance-stabilizing z-transformation
(z-statistic), which dramatically increases the comparability between samples generated by different MS runs. The z-statistic can be widely applied in downstream 
analyses, including PCA, clustering analysis, GSVA, and so on.
zMAP requires that all the involved MS runs are associated with the same biological design, such that the average intensities across all samples in each run are biologically identical.

# Workflow of zMAP

![Workflow of zMAP](https://github.com/guixiuqi/zMAP/blob/main/imgs/zMAP_workflow.png "zMAP Workflow")

# Try it

A Web-based application of zMAP is provided at http://bioinfo.sibs.ac.cn/shaolab/zMAP. 


# Installation
## From source code
The scripts of zMAP  require no installation and can be used in-place. Just install the dependencies (see below)

```python
git clone https://github.com/guixiuqi/zMAP.git
cd ./zmap
scriptPATH=./python_script
export scriptPATH
gmtPATH=./data/gmt
inputdataPATH=./data
```
## Python dependencies
```bat
conda install matplotlib
conda install conda-forge::pandas
conda install anaconda::scipy
conda install anaconda::seaborn
conda install -c conda-forge scikit-learn
```

## R dependencies
```bat
library(GSVA)
library(limma)
library(GSEABase,quietly=TRUE)

```


# Usage

## zMAP
zMAP models the mean-variance dependence associated with ILMS intensities and accordingly applies a variance-stabilizing z-transformation (z-statistic), which dramatically increases the comparability between samples generated by different MS runs. The z-statistic can be widely applied in downstream analyses.

Two input files provided by user:

1. Protein intensity file
   
    A tab-delimited file containing raw gene-level protein intensity with samples in columns, and gene symbols in rows.
Note:(1). The protein intensity matrix does not require normalization.(2). Sample names can only consist of letters, numbers, and underscores.

2. Sample information file

    Sample information file is a three-column, tab-delimited file with the first line identifying the columns. The column names are ```Sample_id```, ```Sample_condition```, and ```MS_run```.

Use the command shown as below:

```bat
python $scriptPATH/zmap_step1_quantity_anaysis.py --protein_intensity_file $inputdataPATH/test_data/raw_protein_intensity_in_gene_level_for_web.txt --sample_info $inputdataPATH/test_data/zmap_sample_info_for_web.txt --outdir $inputdataPATH/test_data/zMAP_results --window_size 400 --step_size 100 --percent 30 -method exponential_function
```
## Downstream analyses based on z-statistic

### Sample Quality Control

Performing principal component and hierarchical clustering analysis on the z-statistic matrix of samples provides a concise visualization of the overall impact of sample conditions and MS runs.
![QC of zMAP](https://github.com/guixiuqi/zMAP/blob/main/imgs/zmap_QC.png "zMAPQC")

Two input files provided by user:

1. Output file z_statistic_table.txt from zMAP


    Note:(1). The protein intensity matrix does not require normalization.(2). Sample names can only consist of letters, numbers, and underscores.

2. Sample information file

    Sample information file is a three-column, tab-delimited file with the first line identifying the columns. The column names are ```Sample_id```, ```Sample_condition```, and ```MS_run```.

Use the command shown as below:
```bat
python $scriptPATH/sample_quality_control.py --z_statistic_matrix $inputdataPATH/test_data/zMAP_results/z_statistic_table.txt --sample_info $inputdataPATH/test_data/zmap_sample_info_for_web.tx
t --outdir $inputdataPATH/test_data/sample_quality_control
```
### Hypervariable proteins(HVPs) identification and clustering

The chi-square statistics derived by zMAP along with the associated numbers of degrees of freedom were summed across MS runs for each protein, giving rise to a p-value that assessed the overall expression variability of the protein. This functionality is designed toOut select hypervariable proteins (HVPs) from the output files of zMAP and cluster them to obtain multiple expression signatures. Then, pathway enrichment analysis was conducted on these signatures to reveal biological insights.
![HVPs](https://github.com/guixiuqi/zMAP/blob/main/imgs/zmap_hvps_cluster.png "zMAP_Hvps")

Three input files provided by user:

1. Output file zmap_chi_square_pvalue.txt from zMAP 


2. Output file z_statistic_table.txt from zMAP


    Note: (1). The protein intensity matrix does not require normalization. (2). Sample names can only consist of letters, numbers, and underscores.

3. Sample information file

    Sample information file is a three-column, tab-delimited file with the first line identifying the columns. The column names are ```Sample_id```, ```Sample_condition```, and ```MS_run```.
   
Parameters:

1. Number of HVP clusters (```--cluster_number_for_hypervariable```)

   HVPs are hierarchically clustered into multiple clusters revealing diverse expression signatures across different sample conditions.

2. Minimum proteins within each cluster (```--minclustersize```)

   If the number of proteins within certain clusters falls below the specified minimum, these clusters will be merged into a single cluster labeled as cluster_0. As a result, the final number of clusters may be fewer than what the user initially specified.

3. Number of top-ranked DEPs (```--top```)

   Top-ranked proteins are selected for heatmap visualization.

4. Number of DEP clusters (```--cluster_number_for_top_proteins```)

   Top-ranked DEPs are clustered into multiple clusters based on K-means.

5. FDR (```--fdr```)

   BH-adjusted pvalue cutoff for significance.

Use the command shown as below:
```bat
python $scriptPATH/zmap_hypervariable_proteins_cluster.py --pvalue_results $inputdataPATH/test_data/zMAP_results/zmap_chi_square_pvalue.txt --z_statistic_matrix $inputdataPATH/test_data/zMAP_results/z_statistic_table.txt --sample_info $inputdataPATH/test_data/zmap_sample_info_for_web.txt --outdir $inputdataPATH/test_data/zmap_hypervariable_proteins_cluster --cluster_number_for_hypervariable 15 --minclustersize 20 --top 100 --cluster_number_for_top_proteins 8 --fdr 0.05
```
### Gene set variation analysis
GSVA calculates gene set enrichment scores (GSVA scores) for each sample using the z-statistic matrix.
Differential expression analysis is then conducted on these GSVA scores using limma, aiming to identify differentially regulated pathways across sample groups. Finally, the differential pathway activities across sample groups are visualized using a heatmap.
![GSVA of zMAP](https://github.com/guixiuqi/zMAP/blob/main/imgs/zmap_gsva.png "zMAP_GSVA")

Two input files provided by user:

1. Output file z_statistic_table.txt from zMAP


    Note:(1). The protein intensity matrix does not require normalization.(2). Sample names can only consist of letters, numbers, and underscores.

2. Sample information file

    Sample information file is a three-column, tab-delimited file with the first line identifying the columns. The column names are ```Sample_id```, ```Sample_condition```, and ```MS_run```.

Parameters:

1. Top N(number) Pathways (```--top_n```)
 
   Extract a table of the top-ranked differentially regulated pathways across sample groups.

2. FDR (```--fdr```)

   BH-adjusted pvalue cutoff for significance.



Use the command shown as below:
```bat
python $scriptPATH/gsva.py --z_statistic_matrix $inputdataPATH/test_data/zMAP_results/z_statistic_table.txt --sample_info $inputdataPATH/test_data/gsva_sample_info.txt --outdir $inputdataPATH//test_data/gsva --top_n 50 --fdr 0.05
```


# Citation

To cite the `zMAP` package in publications, please use


